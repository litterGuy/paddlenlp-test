# 情感分析

## 情感分析任务Label Studio使用指南

### 1. label-studio 安装
本内容在以下环境进行测试安装：

- python == 3.9.12
- label-studio == 1.6.0

在终端(terminal)使用pip安装label-studio：
```python
pip install label-studio==1.6.0
```
安装完成后，运行以下命令行：
```python
label-studio start
```
在浏览器打开http://localhost:8080/，输入用户名和密码登录，开始使用label-studio进行标注。

### 2. label-studio 项目创建

创建项目之前，需要先确定标注的任务类型以及需要标注哪些内容，然后点击创建（Create）开始创建一个新的项目，填写项目名称、描述。

![创建项目][1]

如果数据已经准备好，可以在此进行导入数据。

![导入数据][2]

接下来，根据需要标注的任务类型，选择适合的任务。在本项目中，默认会包含两种类型的任务：语句级情感分类任务和属性级情感分析任务。由于这两者都属于自然语言处理（NLP）任务，因此可以点击 Natural Language Processing 选项，在该选项下面进行选择相应的子项任务。

- 如果标注语句级情感分类任务，请选择Text Classification。

![标注语句级情感分类任务][3]

- 如果标注属性级情感分析任务，比如属性-观点词-情感极性三元组的信息抽取，请选择Relation Extraction。

![标注属性级情感分析任务][4]

### 3. 情感分析任务标注
#### 3.1 语句级情感分类任务

这里对应的任务类型为Text Classification，在标注之前，需要设定正向和负向的标签，然后保存即可。

![设置标签][5]

设定好标签后，即可开始进行标注，选择正向或负向，最后点击提交，便标注好一条数据。

![标注数据][6]

### 4. 导出标注数据

勾选已标注文本ID，点击Export按钮，选择导出的文件类型为JSON，导出数据：

![导出数据][7]

### 官网

- [Label Studio 官网](https://labelstud.io/)


> [参考地址](https://github.com/PaddlePaddle/PaddleNLP/blob/develop/applications/sentiment_analysis/unified_sentiment_extraction/label_studio.md)

---

## 情感分析应用

### 1. 运行环境

**代码结构**
```python
unified_sentiment_extraction/
├── batch_predict.py # 以文件的形式输入，进行批量预测的脚本
├── evaluate.py # 模型评估脚本
├── finetune.py # 模型微调脚本
├── label_studio.py # 将label-studio导出数据转换为模型输入数据的脚本
├── label_studio.md # 将label-studio标注说明
├── utils.py # 工具函数脚本
├── visual_analysis.py # 情感分析结果可视化脚本
└── README.md # 使用说明
```

**安装依赖**

- python == 3.9.12
- paddlepaddle == 2.3.2
- paddlenlp == 2.4.5
- wordcloud == 1.8.2.2

**安装PaddlePaddle：**
环境中paddlepaddle-gpu或paddlepaddle版本应大于或等于2.3, 具体可以参见飞桨快速安装根据自己需求选择合适的PaddlePaddle下载命令。如下命令可以安装linux系统，CUDA版本为10.2环境下的paddlepaddle，具体版本号为支持GPU的2.3.2版本。
```python
conda install paddlepaddle-gpu==2.3.2 cudatoolkit=10.2 --channel https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/Paddle/
```

**安装PaddleNLP：**安装PaddleNLP可以开启百度镜像源来加速下载，更多关于PaddleNLP安装的详细教程请查见PaddleNLP快速安装。

```python
python3 -m pip install --upgrade paddlenlp -i https://mirror.baidu.com/pypi/simple
```
**安装wordcloud：**

```python
python3 -m pip install wordcloud==1.8.2.2
```

### 2. 语句级情感分析
整句情感分析功能当前支持二分类：正向和负向，调用示例如下：

```python
>>> from paddlenlp import Taskflow

>>> schema = ['情感倾向[正向，负向]']
>>> senta = Taskflow("sentiment_analysis", model="uie-senta-base", schema=schema)
>>> print(senta('蛋糕味道不错，店家服务也很好'))

[
    {
        '情感倾向[正向,负向]': [
            {
                'text': '正向',
                'probability': 0.996646058824652
            }
        ]
    }
]
```

### 3. 定制情感分析

#### 3.1 打通数据标注到训练样本构建
本项目建议用户使用 label-studio 平台标注数据，同时提供了一套用于情感信息标注的规则，同时本项目打通了从 label-studio 标注平台到转换为模型输入形式数据的流程， 即支持用户在基于 label_studio 标注业务侧数据后，通过label-studio 导出标注好的json数据， 然后利用本项目提供的 label_studio.py 脚本，可以将导出数据一键转换为模型训练数据。

在利用 label_studio.py 脚本进行数据转换时，需要考虑任务类型的不同，选择相应的样本构建方式，整体可以分为 分类 和 抽取 任务。

![训练样本构建][8]

##### 3.1.1 样本构建：语句级情感分类任务

对于语句级情感分类任务，默认支持2分类：正向 和 负向，可以通过如下命令构造相关训练数据。

```python
python label_studio.py \
    --label_studio_file ./data/label_studio.json \
    --task_type cls \
    --save_dir ./data \
    --splits 0.8 0.1 0.1 \
    --options "正向" "负向" \
    --is_shuffle True \
    --seed 1000
```

参数介绍：

- label_studio_file: 从label studio导出的语句级情感分类的数据标注文件。
- task_type: 选择任务类型，可选有抽取和分类两种类型的任务，其中前者需要设置为ext，后者需要设置为cls。由于此处为语句级情感分类任务，因此需要设置为cls。
- save_dir: 训练数据的保存目录，默认存储在data目录下。
- splits: 划分数据集时训练集、验证集所占的比例。默认为[0.8, 0.1, 0.1]表示按照8:1:1的比例将数据划分为训练集、验证集和测试集。
- options: 情感极性分类任务的选项设置。对于语句级情感分类任务，默认支持2分类：正向 和 负向；对于属性级情感分析任务，默认支持3分类：正向, 负向和 未提及，其中未提及表示要分析的属性在原文本评论中未提及，因此无法分析情感极性。如果业务需要其他情感极性选项，可以通过options字段进行设置，需要注意的是，如果定制了options，参数label_studio_file指定的文件需要包含针对新设置的选项的标注数据。
- is_shuffle: 是否对数据集进行随机打散，默认为True。
- seed: 随机种子，默认为1000.

**备注**：参数options可以不进行手动指定，如果这么做，则采用默认的设置。针对语句级情感分类任务，其默认将被设置为："正向" "负向"；对于属性级情感分析任务，默认将被设置为："正向" "负向" "未提及"。

##### 3.1.2 样本构建升级2：加强隐性观点抽取能力
另外，本项目同时支持加强对隐性观点功能抽取的能力，这里需要说明一点，本项目中定义隐性观点是指没有对应属性的纯观点词，如以下示例中的"比较便宜"便是隐性观点。

```python
蛋糕味道不错，外观很漂亮，而且比较便宜
```
本项目支持用户提供一个隐性观点映射文件，用户可以根据自己的业务场景定义隐性观点词，以下给出了酒店场景的示例。其格式为，第1个单词为隐性观点对应的属性，后续按照情感情感倾向对隐性观点词进行了归类，同一类的以"[ ]"方式放到一块。
```python
价格, 正向[实惠 便宜 超划算 划算 物超所值 物有所值 不贵], 负向[贵 不便宜 不划算]
卫生, 正向[干净], 负向[很脏 很臭 不干净]
隔音, 负向[好吵]
位置, 负向[不太好找]
```

可以通过参数"implicit_file"指定凝聚业务经验的隐性观点词表，生成对应的隐性观点数据样本：

```python
python label_studio.py \
    --label_studio_file ./data/label_studio.json \
    --implicit_file ./data/implicit_opinions.txt \
    --task_type ext \
    --save_dir ./data \
    --splits 0.8 0.1 0.1 \
    --options "正向" "负向" "未提及" \
    --negative_ratio 5 \
    --is_shuffle True \
    --seed 1000
```

### 4. 模型训练
在生成酒店场景的训练数据后，可以通过以下命令启动模型训练：
```python
python -u -m paddle.distributed.launch --gpus "0" finetune.py \
  --train_path ./data/train.json \
  --dev_path ./data/dev.json \
  --save_dir ./checkpoint \
  --learning_rate 1e-5 \
  --batch_size 16 \
  --max_seq_len 512 \
  --num_epochs 3 \
  --model uie-senta-base \
  --seed 1000 \
  --logging_steps 10 \
  --valid_steps 100 \
  --device gpu
```
可配置参数说明：
- train_path：必须，训练集文件路径。
- dev_path：必须，验证集文件路径。
- save_dir：模型 checkpoints 的保存目录，默认为"./checkpoint"。
- learning_rate：训练最大学习率，UIE 推荐设置为 1e-5；默认值为1e-5。
- batch_size：训练集训练过程批处理大小，请结合显存情况进行调整，若出现显存不足，请适当调低这一参数；默认为 16。
- max_seq_len：模型支持处理的最大序列长度，默认为512。
- num_epochs：模型训练的轮次，可以视任务情况进行调整，默认为10。
model：训练使用的预训练模型。可选择的有uie-senta-base, uie-senta-medium, uie-senta-mini, uie-senta-micro, - uie-senta-nano，默认为uie-senta-base。
- logging_steps: 训练过程中日志打印的间隔 steps 数，默认10。
- valid_steps: 训练过程中模型评估的间隔 steps 数，默认100。
- seed：全局随机种子，默认为 42。
- device: 训练设备，可选择 'cpu'、'gpu' 其中的一种；默认为 GPU 训练。


### 5. 模型测试
通过运行以下命令进行对酒店场景的测试集进行评估：

```python
python evaluate.py \
    --model_path ./checkpoint/model_best \
    --test_path ./data/test.json \
    --batch_size 16 \
    --max_seq_len 512
```
可配置参数说明：
- model_path：必须，进行评估的模型文件夹路径，路径下需包含模型权重文件model_state.pdparams及配置文件model_config.json。
- test_path：必须，进行评估的测试集文件。
- batch_size：训练集训练过程批处理大小，请结合显存情况进行调整，若出现显存不足，请适当调低这一参数；默认为 16。
- max_seq_len：文本最大切分长度，输入超过最大长度时会对输入文本进行自动切分，默认为512。
- debug： 是否开启debug模式对每个正例类别分别进行评估，该模式仅用于模型调试，默认关闭。

在构造样本过程中，如果设置了最大负例比例negative_ratio，会在样本中添加一定数量的负样本，模型测试默认会对正样本和负样本共同进行评估。特别地，当开启debug模式后，会对每个正例类别分别进行评估，该模式仅用于模型调试：
```python
python evaluate.py \
    --model_path ./checkpoint/model_best \
    --test_path ./data/test.json \
    --batch_size 16 \
    --max_seq_len 512 \
    --debug
```

输出打印示例：

```python
[2022-12-12 05:20:06,152] [    INFO] - -----------------------------
[2022-12-12 05:20:06,152] [    INFO] - Class Name: 评价维度
[2022-12-12 05:20:06,152] [    INFO] - Evaluation Precision: 0.89655 | Recall: 0.89655 | F1: 0.89655
[2022-12-12 05:20:06,553] [    INFO] - -----------------------------
[2022-12-12 05:20:06,553] [    INFO] - Class Name: 观点词
[2022-12-12 05:20:06,553] [    INFO] - Evaluation Precision: 0.81159 | Recall: 0.86154 | F1: 0.83582
[2022-12-12 05:20:07,610] [    INFO] - -----------------------------
[2022-12-12 05:20:07,611] [    INFO] - Class Name: X的观点词
[2022-12-12 05:20:07,611] [    INFO] - Evaluation Precision: 0.92222 | Recall: 0.90217 | F1: 0.91209
[2022-12-12 05:20:08,331] [    INFO] - -----------------------------
[2022-12-12 05:20:08,331] [    INFO] - Class Name: X的情感倾向[未提及,正向,负向]
[2022-12-12 05:20:08,331] [    INFO] - Evaluation Precision: 0.81481 | Recall: 0.81481 | F1: 0.81481
```

### 6.  隐性观点词抽取预测和分析
对于"价格"的调用示例：
```python
>>> schema = [{'评价维度': ['观点词', '情感倾向[正向,负向,未提及]']}]
>>> aspects = ["价格"]
>>> senta = Taskflow("sentiment_analysis", model="uie-senta-base", schema=schema, task_path="./checkpoint/model_best", aspects=aspects)
>>> senta("这家店的房间很大，店家服务也很热情，而且很便宜")
```

> [参考](https://github.com/PaddlePaddle/PaddleNLP/tree/develop/applications/sentiment_analysis/unified_sentiment_extraction)

---

[1]: img/label/1.png
[2]: img/label/2.png
[3]: img/label/3.png
[4]: img/label/4.png
[5]: img/label/5.png
[6]: img/label/6.png
[7]: img/label/7.png
[8]: img/label/8.png